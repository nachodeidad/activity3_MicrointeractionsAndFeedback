<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo - Tijuana, BC</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <style>
        #map { width: 100%; height: 100vh; }
        
        .leaflet-control-zoom {
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .leaflet-control-zoom a {
            width: 44px !important;
            height: 44px !important;
            line-height: 44px !important;
            font-size: 24px !important;
            font-weight: bold;
        }
        
        .leaflet-bottom.leaflet-right { bottom: 80px; }
        
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px 16px;
            margin-bottom: 10px;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
        }
        
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.info { border-left: 4px solid #3b82f6; }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        
        .toast.hiding { animation: slideOut 0.3s ease-in forwards; }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }
        
        .popup-content { padding: 16px; min-width: 200px; }
        .popup-title { font-weight: bold; font-size: 16px; margin-bottom: 12px; color: #1f2937; }
        .popup-buttons { display: flex; gap: 8px; margin-top: 12px; }
        
        .btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }
        
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .locate-btn {
            position: absolute;
            bottom: 160px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 10px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }
        
        .locate-btn:hover { background: #f9fafb; }
        .locate-btn:active { transform: scale(0.95); }
        
        /* RESPONSIVE */
        @media (max-width: 480px) {
            .leaflet-control-zoom a {
                width: 40px !important;
                height: 40px !important;
                line-height: 40px !important;
                font-size: 22px !important;
            }
            .leaflet-bottom.leaflet-right { bottom: 60px; right: 8px; }
            #header { padding: 8px 12px; }
            #header h1 { font-size: 1rem; }
            #footer { font-size: 0.65rem; padding: 4px 8px; }
            .toast-container { right: 10px; left: 10px; top: 70px; }
            .toast { min-width: auto; width: 100%; }
            .locate-btn { bottom: 120px; right: 8px; width: 40px; height: 40px; }
            .popup-content { min-width: 180px; }
            .btn { font-size: 13px; padding: 10px 12px; }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .leaflet-control-zoom a {
                width: 48px !important;
                height: 48px !important;
                line-height: 48px !important;
                font-size: 26px !important;
            }
            .leaflet-bottom.leaflet-right { bottom: 70px; }
            .locate-btn { bottom: 150px; width: 48px; height: 48px; }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .leaflet-control-zoom a {
                width: 42px !important;
                height: 42px !important;
                line-height: 42px !important;
                font-size: 22px !important;
            }
        }
        
        @media (min-width: 1025px) {
            .leaflet-control-zoom a {
                width: 36px !important;
                height: 36px !important;
                line-height: 36px !important;
                font-size: 20px !important;
            }
            .leaflet-bottom.leaflet-right { bottom: 20px; }
            #header { padding: 12px 20px; }
            #footer { bottom: 20px; left: 20px; }
            .locate-btn { bottom: 80px; right: 10px; width: 36px; height: 36px; }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            #header { padding: 4px 12px; }
            #header h1 { font-size: 0.875rem; }
            #footer { display: none; }
            .leaflet-bottom.leaflet-right { bottom: 10px; }
            .locate-btn { bottom: 60px; }
            .toast-container { top: 50px; }
        }
    </style>
</head>
<body class="m-0 p-0 overflow-hidden">
    
    <div id="header" class="absolute top-0 left-0 right-0 z-[1000] bg-white/80 backdrop-blur-sm shadow-md pointer-events-none">
        <div class="container mx-auto px-4 py-2 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-gray-800">Tijuana, BC</h1>
            </div>
            <div class="pointer-events-auto">
                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-semibold">
                    MODO PREVIEW
                </span>
            </div>
        </div>
    </div>
    
    <div id="map" class="w-full h-screen"></div>
    
    <button class="locate-btn" id="locateBtn" title="Mi ubicaci√≥n">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="2" x2="12" y2="6"/>
            <line x1="12" y1="18" x2="12" y2="22"/>
            <line x1="2" y1="12" x2="6" y2="12"/>
            <line x1="18" y1="12" x2="22" y2="12"/>
        </svg>
    </button>
    
    <div id="footer" class="absolute bottom-2 left-2 z-[1000] bg-white/75 backdrop-blur-sm px-3 py-1 rounded-md shadow-sm pointer-events-none">
        <p class="text-xs text-gray-600">Clic para agregar punto</p>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>

    <script>
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '';
            if (type === 'success') {
                icon = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" fill="#10b981"/></svg>';
            } else if (type === 'error') {
                icon = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" fill="#ef4444"/></svg>';
            } else {
                icon = '<div class="spinner"></div>';
            }
            
            toast.innerHTML = `${icon}<span style="flex: 1; font-size: 14px; color: #374151;">${message}</span>`;
            container.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
            
            return toast;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const tijuanaCoords = [32.5149, -117.0382];
            let initialZoom = window.innerWidth <= 480 ? 11 : window.innerWidth <= 768 ? 12 : 13;
            
            const map = L.map('map', {
                center: tijuanaCoords,
                zoom: initialZoom,
                zoomControl: true
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19,
                minZoom: 3
            }).addTo(map);
            
            map.zoomControl.setPosition('bottomright');
            
            L.marker(tijuanaCoords).addTo(map).bindPopup(`
                <div class="text-center">
                    <h3 class="font-bold text-lg">Tijuana</h3>
                    <p class="text-sm text-gray-600">Baja California, Mexico</p>
                </div>
            `);
            
            L.circle(tijuanaCoords, {
                color: '#3b82f6',
                fillColor: '#60a5fa',
                fillOpacity: 0.2,
                radius: 2000
            }).addTo(map);
            
            let temporalMarker = null;
            let currentPopup = null;
            let savedMarkers = [];
            let routeLine = null;
            let isSaving = false;
            const MAX_POINTS = 2;
            
            map.on('click', function(e) {
                if (savedMarkers.length >= MAX_POINTS) {
                    showToast(`M√°ximo ${MAX_POINTS} puntos. Elimina uno para agregar otro.`, 'error', 3000);
                    return;
                }
                
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                if (currentPopup) map.closePopup(currentPopup);
                if (temporalMarker) map.removeLayer(temporalMarker);
                
                const grayIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #9ca3af; width: 30px; height: 30px; border-radius: 50% 50% 50% 0; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transform: rotate(-45deg);"></div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });
                
                temporalMarker = L.marker([lat, lng], { icon: grayIcon }).addTo(map);
                
                const pointNumber = savedMarkers.length + 1;
                currentPopup = L.popup({
                    closeButton: false,
                    autoClose: true,
                    closeOnClick: true
                })
                .setLatLng([lat, lng])
                .setContent(`
                    <div class="popup-content">
                        <div class="popup-title">¬øGuardar punto ${pointNumber}/${MAX_POINTS}?</div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                            Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}
                        </div>
                        <div class="popup-buttons">
                            <button class="btn btn-secondary" onclick="window.cancelarPunto()">Cancelar</button>
                            <button class="btn btn-primary" onclick="window.guardarPunto(${lat}, ${lng})">Guardar</button>
                        </div>
                    </div>
                `)
                .openOn(map);
            });
            
            map.on('popupclose', function(e) {
                if (e.popup === currentPopup && temporalMarker && !isSaving) {
                    setTimeout(() => {
                        if (temporalMarker && map.hasLayer(temporalMarker) && !isSaving) {
                            map.removeLayer(temporalMarker);
                            temporalMarker = null;
                        }
                        currentPopup = null;
                    }, 100);
                }
            });
            
            window.cancelarPunto = function() {
                if (temporalMarker) {
                    map.removeLayer(temporalMarker);
                    temporalMarker = null;
                }
                if (currentPopup) {
                    map.closePopup(currentPopup);
                    currentPopup = null;
                }
                showToast('Punto cancelado', 'info', 2000);
            };
            
            window.eliminarPunto = function(markerId) {
                const index = savedMarkers.findIndex(m => m.id === markerId);
                if (index === -1) return;
                
                map.removeLayer(savedMarkers[index].marker);
                savedMarkers.splice(index, 1);
                
                if (routeLine) {
                    map.removeLayer(routeLine);
                    routeLine = null;
                }
                
                showToast(savedMarkers.length === 0 ? 'Todos los puntos eliminados' : 'Punto eliminado. Agrega otro para crear ruta.', 'info', 2000);
            };
            
            async function drawRoute() {
                if (savedMarkers.length !== 2) return;
                
                if (routeLine) map.removeLayer(routeLine);
                
                const point1 = savedMarkers[0].coords;
                const point2 = savedMarkers[1].coords;
                const routingToast = showToast('Calculando ruta...', 'info', 0);
                
                try {
                    const url = `https://router.project-osrm.org/route/v1/driving/${point1[1]},${point1[0]};${point2[1]},${point2[0]}?overview=full&geometries=geojson`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
                        throw new Error('No se pudo calcular la ruta');
                    }
                    
                    const route = data.routes[0];
                    const latlngs = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    routeLine = L.polyline(latlngs, {
                        color: '#3b82f6',
                        weight: 5,
                        opacity: 0.8,
                        lineJoin: 'round',
                        lineCap: 'round'
                    }).addTo(map);
                    
                    const distance = (route.distance / 1000).toFixed(2);
                    const duration = Math.round(route.duration / 60);
                    
                    routeLine.bindPopup(`
                        <div style="padding: 10px; min-width: 180px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">üöó Ruta por calles</div>
                            <div style="font-size: 12px; color: #6b7280;">
                                <div>üìè Distancia: <b style="color: #3b82f6;">${distance} km</b></div>
                                <div>‚è±Ô∏è Tiempo: <b style="color: #3b82f6;">${duration} min</b></div>
                            </div>
                        </div>
                    `);
                    
                    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                    routingToast.remove();
                    showToast(`Ruta: ${distance} km (${duration} min)`, 'success', 4000);
                    
                } catch (error) {
                    routingToast.remove();
                    routeLine = L.polyline([point1, point2], {
                        color: '#ef4444',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(map);
                    
                    const distance = (map.distance(point1, point2) / 1000).toFixed(2);
                    routeLine.bindPopup(`<div style="padding: 8px; text-align: center;"><b>‚ö†Ô∏è L√≠nea directa</b><br>~${distance} km</div>`);
                    showToast('No se pudo calcular ruta. Mostrando l√≠nea directa.', 'error', 3000);
                }
            }
            
            window.guardarPunto = async function(lat, lng) {
                isSaving = true;
                
                if (currentPopup) {
                    map.closePopup(currentPopup);
                    currentPopup = null;
                }
                
                const loadingToast = showToast('Guardando punto...', 'info', 0);
                
                try {
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                    
                    const pointId = `punto_${Date.now()}`;
                    const pointNumber = savedMarkers.length + 1;
                    
                    loadingToast.remove();
                    
                    if (temporalMarker) {
                        map.removeLayer(temporalMarker);
                        
                        const redIcon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="background: #ef4444; width: 30px; height: 30px; border-radius: 50% 50% 50% 0; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transform: rotate(-45deg); animation: bounce 0.5s; position: relative;"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); color: white; font-weight: bold; font-size: 14px;">${pointNumber}</div></div><style>@keyframes bounce { 0%, 100% { transform: rotate(-45deg) translateY(0); } 50% { transform: rotate(-45deg) translateY(-10px); }}</style>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        });
                        
                        const savedMarker = L.marker([lat, lng], { icon: redIcon }).addTo(map);
                        
                        savedMarker.bindPopup(`
                            <div style="padding: 8px; min-width: 150px;">
                                <div style="font-weight: bold; margin-bottom: 4px;">Punto ${pointNumber} ‚úì</div>
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">
                                    Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}
                                </div>
                                <button class="btn btn-secondary" onclick="window.eliminarPunto('${pointId}')" style="width: 100%; font-size: 12px; padding: 6px;">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        `);
                        
                        savedMarkers.push({
                            id: pointId,
                            marker: savedMarker,
                            coords: [lat, lng]
                        });
                        
                        temporalMarker = null;
                        
                        if (savedMarkers.length === 2) {
                            await drawRoute();
                        } else {
                            showToast('Agrega un segundo punto para la ruta', 'info', 3000);
                        }
                    }
                    
                    if (savedMarkers.length !== 2) {
                        showToast('¬°Punto guardado!', 'success', 3000);
                    }
                    
                    isSaving = false;
                    
                } catch (error) {
                    isSaving = false;
                    loadingToast.remove();
                    showToast('Error al guardar. Intenta nuevamente.', 'error', 5000);
                    
                    if (temporalMarker) {
                        temporalMarker.bindPopup(`
                            <div class="popup-content">
                                <div style="color: #ef4444; font-weight: bold; margin-bottom: 8px;">‚ö†Ô∏è Error</div>
                                <div class="popup-buttons">
                                    <button class="btn btn-secondary" onclick="window.cancelarPunto()">Cancelar</button>
                                    <button class="btn btn-primary" onclick="window.guardarPunto(${lat}, ${lng})">Reintentar</button>
                                </div>
                            </div>
                        `).openPopup();
                    }
                }
            };
            
            document.getElementById('locateBtn').addEventListener('click', function() {
                if (!navigator.geolocation) {
                    showToast('Geolocalizaci√≥n no disponible', 'error', 3000);
                    return;
                }
                
                const btn = this;
                btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px;"></div>';
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        map.setView([position.coords.latitude, position.coords.longitude], 15, { animate: true });
                        
                        const userIcon = L.divIcon({
                            html: '<div style="background: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        });
                        
                        L.marker([position.coords.latitude, position.coords.longitude], { icon: userIcon })
                            .addTo(map)
                            .bindPopup('Tu ubicaci√≥n')
                            .openPopup();
                        
                        btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><circle cx="12" cy="12" r="10"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/></svg>';
                        showToast('Ubicaci√≥n encontrada', 'success', 2000);
                    },
                    function(error) {
                        btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><circle cx="12" cy="12" r="10"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/></svg>';
                        showToast(error.code === 1 ? 'Permiso denegado' : 'No se pudo obtener ubicaci√≥n', 'error', 3000);
                    }
                );
            });
            
            window.addEventListener('resize', () => map.invalidateSize());
            window.addEventListener('orientationchange', () => setTimeout(() => map.invalidateSize(), 200));
        });
    </script>
    
</body>
</html>